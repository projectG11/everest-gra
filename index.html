<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Everest - Wy≈õcig Agent√≥w (Ranking + AI)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { overflow: hidden; touch-action: none; background-color: #f8fafc; }
        canvas { display: block; box-shadow: 0 10px 25px rgba(0,0,0,0.2); border-radius: 12px; cursor: crosshair; }
        .leaderboard-item { transition: all 0.2s ease-in-out; }
        .leaderboard-item:hover { transform: scale(1.02); background-color: #f1f5f9; }
        @keyframes pulse-soft { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse-soft { animation: pulse-soft 2s infinite; }
        .gemini-gradient { background: linear-gradient(90deg, #4285f4, #9b72cb, #d96570); }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center font-sans text-slate-800 p-4">

    <div class="flex flex-col lg:flex-row items-stretch gap-8 max-w-7xl w-full">
        
        <!-- LEWA STRONA: GRA -->
        <div class="flex-1 flex flex-col items-center">
            <div class="mb-6 text-center">
                <h1 class="text-4xl md:text-5xl font-black text-slate-900 tracking-tighter uppercase italic">
                    üèîÔ∏è Everest <span class="text-blue-600 font-light text-3xl">Game</span>
                </h1>
                <p class="text-slate-500 font-bold tracking-widest text-xs mt-1 uppercase">Inteligentne Wsparcie Sprzeda≈ºy ‚ú®</p>
            </div>

            <div class="flex gap-4 mb-4 text-xl font-black w-full max-w-[800px] justify-between px-6 py-4 bg-white rounded-2xl shadow-sm border border-slate-200">
                <div class="text-blue-600 flex items-center gap-3">
                    <div class="w-4 h-4 bg-blue-600 rounded-sm"></div>
                    <span id="score1" class="text-3xl font-mono">0</span>
                </div>
                <div class="bg-slate-100 px-4 py-1 rounded-full text-slate-500 font-mono text-2xl" id="timer">60s</div>
                <div class="text-red-500 flex items-center gap-3 text-right">
                    <span id="score2" class="text-3xl font-mono">0</span>
                    <div class="w-4 h-4 bg-red-500 rounded-sm"></div>
                </div>
            </div>

            <div class="relative w-full max-w-[800px]">
                <canvas id="gameCanvas" width="800" height="500" class="w-full h-auto bg-white border-4 border-white shadow-2xl"></canvas>
                
                <!-- Overlay -->
                <div id="gameOverlay" class="absolute inset-0 bg-slate-900/95 flex flex-col items-center justify-center text-white rounded-xl p-8 text-center z-20 backdrop-blur-sm">
                    <div id="startContent">
                        <div class="mb-6 inline-block p-4 bg-blue-600 rounded-full animate-bounce">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                           </svg>
                        </div>
                        <h2 class="text-5xl font-black mb-8 italic tracking-tighter">ZACZYNAMY?</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-10 text-left">
                            <div class="p-4 bg-slate-800/50 rounded-xl border-l-4 border-blue-500">
                                <p class="text-blue-400 font-black text-xs uppercase tracking-widest mb-1 font-sans">Niebieski</p>
                                <p class="text-lg font-bold">Strza≈Çki</p>
                            </div>
                            <div class="p-4 bg-slate-800/50 rounded-xl border-l-4 border-red-500">
                                <p class="text-red-400 font-black text-xs uppercase tracking-widest mb-1 font-sans">Czerwony</p>
                                <p class="text-lg font-bold">W, A, S, D</p>
                            </div>
                        </div>
                        <button id="startBtn" class="w-full sm:w-auto px-16 py-5 bg-white text-slate-900 hover:bg-blue-500 hover:text-white rounded-xl font-black text-2xl transition-all transform hover:scale-105 shadow-xl uppercase tracking-tighter">
                            Wystaw polisy
                        </button>
                    </div>

                    <div id="endContent" class="hidden w-full max-w-md overflow-y-auto max-h-full">
                        <h2 class="text-4xl font-black mb-2 italic">KONIEC CZASU</h2>
                        <p id="winnerText" class="text-2xl text-yellow-400 mb-4 font-bold uppercase"></p>
                        
                        <!-- ‚ú® Komentarz AI -->
                        <div id="aiCommentContainer" class="hidden mb-6 p-4 bg-blue-900/40 rounded-xl border border-blue-500/30 text-sm italic text-blue-100">
                            <p id="aiCommentText">Generowanie analizy sprzeda≈ºy...</p>
                        </div>

                        <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-2xl">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-slate-400 text-[10px] uppercase tracking-[0.3em] font-black">Podpis Agenta</label>
                                <button id="generateNicknameBtn" class="text-[9px] bg-blue-600/30 hover:bg-blue-600 px-2 py-1 rounded uppercase font-bold transition">
                                    ‚ú® Generuj nick
                                </button>
                            </div>
                            <input type="text" id="winnerName" placeholder="Imiƒô" maxlength="12" 
                                class="w-full p-3 rounded-xl bg-slate-900 text-white border-2 border-slate-700 mb-4 focus:outline-none focus:border-blue-500 text-center text-xl font-black uppercase tracking-widest">
                            
                            <button id="saveScoreBtn" class="w-full py-4 bg-blue-600 hover:bg-blue-500 rounded-xl font-black text-lg mb-4 transition-all shadow-lg uppercase">
                                Zapisz w Rankingu
                            </button>
                            <button id="restartBtn" class="text-slate-500 hover:text-white transition text-xs font-black uppercase tracking-widest">
                                Jeszcze raz
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PRAWA STRONA: RANKING -->
        <div class="w-full lg:w-96 bg-white rounded-3xl shadow-2xl border border-slate-200 flex flex-col overflow-hidden">
            <div class="bg-slate-900 p-8 text-white">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="text-2xl font-black italic uppercase leading-none">Ranking</h3>
                        <p class="text-[10px] text-blue-400 font-bold uppercase tracking-widest mt-2">Everest Cloud</p>
                    </div>
                    <div id="statusIndicator" class="flex items-center gap-2 bg-slate-800 px-3 py-1 rounded-full border border-slate-700">
                        <span id="statusDot" class="w-2 h-2 bg-red-500 rounded-full animate-pulse-soft"></span>
                        <span id="statusText" class="text-[9px] font-black uppercase tracking-tighter">Offline</span>
                    </div>
                </div>
            </div>
            <div id="leaderboardList" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50 min-h-[400px]">
                <div class="animate-pulse space-y-4">
                    <div class="h-16 bg-slate-200 rounded-2xl"></div>
                    <div class="h-16 bg-slate-200 rounded-2xl opacity-60"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        // Konfiguracja Firebase
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'everest-ai-v1';
        const apiKey = ""; // Klucz dostarczany przez ≈õrodowisko

        let currentUser = null;

        // --- GEMINI API INTEGRATION ---
        async function callGemini(prompt) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: "Jeste≈õ ekspertem ds. sprzeda≈ºy w Agencji Ubezpieczeniowej Everest w Jonkowie. M√≥wisz profesjonalnie, ale z humorem i lokalnym patriotyzmem." }] }
                    })
                });
                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text || "B≈ÇƒÖd komunikacji z AI";
            } catch (e) {
                return "AI odpoczywa po ciƒô≈ºkim dniu sprzeda≈ºy.";
            }
        }

        async function generateAIComment(score1, score2) {
            const container = document.getElementById('aiCommentContainer');
            const textEl = document.getElementById('aiCommentText');
            container.classList.remove('hidden');
            textEl.innerText = "Analiza sprzeda≈ºy przez AI...";

            const winner = score1 > score2 ? "Agent 1 (Niebieski)" : (score2 > score1 ? "Agent 2 (Czerwony)" : "Obaj Agenci");
            const total = score1 + score2;
            
            const prompt = `Zinterpretuj wynik meczu ubezpieczeniowego. Zwyciƒôzca: ${winner}, zdoby≈Ç ${Math.max(score1, score2)} polis. Razem zebrali ${total} polis. Napisz jedno kr√≥tkie, motywujƒÖce zdanie (max 150 znak√≥w) dla agent√≥w z Jonkowa.`;
            
            const comment = await callGemini(prompt);
            textEl.innerText = "‚ú® " + comment;
        }

        async function generateNickname() {
            const btn = document.getElementById('generateNicknameBtn');
            const input = document.getElementById('winnerName');
            btn.disabled = true;
            btn.innerText = "...";

            const prompt = "Wymy≈õl jeden kreatywny, kr√≥tki (max 12 znak√≥w) pseudonim dla mistrza sprzeda≈ºy ubezpiecze≈Ñ. Tylko jedno s≈Çowo lub dwa kr√≥tkie. Bez cudzys≈Çowu.";
            const nick = await callGemini(prompt);
            input.value = (nick || "").replace(/[".]/g, '').toUpperCase().trim().substring(0, 12);
            
            btn.disabled = false;
            btn.innerText = "‚ú® Nowy";
        }

        // --- CORE GAME & CLOUD ---
        async function connect() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth error", err);
                document.getElementById('statusText').innerText = "Tryb Lokalny";
            }
        }

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                document.getElementById('statusDot').className = "w-2 h-2 bg-green-500";
                document.getElementById('statusText').innerText = "Everest Cloud Online";
                loadRanking();
            }
        });

        function loadRanking() {
            if (!currentUser) return;
            const ref = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
            onSnapshot(ref, (snap) => {
                const data = [];
                snap.forEach(doc => data.push(doc.data()));
                data.sort((a,b) => b.score - a.score);
                renderRanking(data);
            }, (err) => {
                console.error("Snapshot error", err);
                document.getElementById('leaderboardList').innerHTML = `<p class="text-xs p-4 text-slate-400">Ranking niedostƒôpny lokalnie. Wrzuƒá plik jako index.html na GitHub Pages.</p>`;
            });
        }

        function renderRanking(scores) {
            const list = document.getElementById('leaderboardList');
            list.innerHTML = scores.length ? '' : '<div class="text-center py-20 opacity-30 text-xs">Czekamy na rekordy...</div>';
            scores.slice(0, 8).forEach((s, i) => {
                list.innerHTML += `
                    <div class="leaderboard-item flex justify-between items-center p-3 bg-white rounded-xl border border-slate-100 shadow-sm">
                        <div class="flex items-center gap-3">
                            <span class="text-lg font-black ${i < 3 ? 'text-blue-600' : 'text-slate-300'}">#${i+1}</span>
                            <div class="font-black text-slate-800 text-sm uppercase">${s.name}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-black text-slate-900 leading-none">${s.score}</div>
                        </div>
                    </div>`;
            });
        }

        // --- GRA ---
        const canvas = document.getElementById('gameCanvas'), ctx = canvas.getContext('2d');
        let active = false, time = 60, items = [], keys = {}, winScore = 0;
        const p1 = { x: 100, y: 250, score: 0, color: '#2563eb' };
        const p2 = { x: 700, y: 250, score: 0, color: '#ef4444' };

        window.addEventListener('keydown', e => { keys[e.key] = true; if(e.key.includes('Arrow')) e.preventDefault(); });
        window.addEventListener('keyup', e => keys[e.key] = false);

        function spawn() { items.push({ x: 50+Math.random()*700, y: 50+Math.random()*400 }); }
        
        function update() {
            if(!active) return;
            const speed = 7;
            if(keys.ArrowUp && p1.y > 20) p1.y -= speed; if(keys.ArrowDown && p1.y < 480) p1.y += speed;
            if(keys.ArrowLeft && p1.x > 20) p1.x -= speed; if(keys.ArrowRight && p1.x < 780) p1.x += speed;
            if(keys.w || keys.W) if(p2.y > 20) p2.y -= speed; if(keys.s || keys.S) if(p2.y < 480) p2.y += speed;
            if(keys.a || keys.A) if(p2.x > 20) p2.x -= speed; if(keys.d || keys.D) if(p2.x < 780) p2.x += speed;

            items.forEach((it, i) => {
                [p1, p2].forEach(p => {
                    if(Math.hypot(p.x-it.x, p.y-it.y) < 25) { p.score++; items.splice(i,1); spawn(); updateScoreUI(); }
                });
            });
        }

        function updateScoreUI() {
            document.getElementById('score1').innerText=p1.score; 
            document.getElementById('score2').innerText=p2.score;
        }

        function draw() {
            ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,800,500);
            ctx.strokeStyle = '#f1f5f9'; ctx.lineWidth = 2;
            for(let i=0; i<800; i+=50) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,500); ctx.stroke(); }
            for(let i=0; i<500; i+=50) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(800,i); ctx.stroke(); }
            
            items.forEach(it => {
                ctx.fillStyle = '#10b981'; ctx.beginPath(); ctx.arc(it.x, it.y, 10, 0, 7); ctx.fill();
                ctx.strokeStyle = '#fff'; ctx.lineWidth = 3; ctx.stroke();
            });

            [p1, p2].forEach(p => {
                ctx.fillStyle = p.color;
                ctx.beginPath();
                if(ctx.roundRect) ctx.roundRect(p.x-15, p.y-15, 30, 30, 8); else ctx.fillRect(p.x-15, p.y-15, 30, 30);
                ctx.fill();
            });
        }

        function gameLoop() { if(active) { update(); draw(); requestAnimationFrame(gameLoop); } }

        document.getElementById('startBtn').onclick = () => {
            p1.score = 0; p2.score = 0; time = 60; items = []; updateScoreUI();
            document.getElementById('gameOverlay').classList.add('hidden');
            document.getElementById('aiCommentContainer').classList.add('hidden');
            active = true; for(let i=0; i<5; i++) spawn(); gameLoop();
            const timer = setInterval(() => {
                time--; document.getElementById('timer').innerText = time + "s";
                if(time <= 0) {
                    clearInterval(timer); active = false;
                    document.getElementById('gameOverlay').classList.remove('hidden');
                    document.getElementById('startContent').classList.add('hidden');
                    document.getElementById('endContent').classList.remove('hidden');
                    winScore = Math.max(p1.score, p2.score);
                    document.getElementById('winnerText').innerText = p1.score == p2.score ? "REMIS!" : (p1.score > p2.score ? "AGENT 1 WYGRYWA!" : "AGENT 2 WYGRYWA!");
                    generateAIComment(p1.score, p2.score);
                }
            }, 1000);
        };

        document.getElementById('saveScoreBtn').onclick = async () => {
            if (!currentUser) return alert("B≈ÇƒÖd po≈ÇƒÖczenia z chmurƒÖ. Upewnij siƒô, ≈ºe strona ma rozszerzenie .html");
            const name = document.getElementById('winnerName').value.trim();
            if(!name) return alert("Podpisz siƒô!");
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard'), { 
                    name: name.toUpperCase(), 
                    score: winScore, 
                    date: new Date().toLocaleDateString('pl-PL') 
                });
                location.reload();
            } catch(e) { alert("B≈ÇƒÖd zapisu danych do Everest Cloud."); }
        };

        document.getElementById('generateNicknameBtn').onclick = generateNickname;
        document.getElementById('restartBtn').onclick = () => location.reload();

        connect();
        draw();
    </script>
</body>
</html>
